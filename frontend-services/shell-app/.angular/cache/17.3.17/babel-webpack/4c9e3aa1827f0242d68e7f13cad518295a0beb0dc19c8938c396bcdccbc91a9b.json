{"ast":null,"code":"import { HttpHeaders } from '@angular/common/http';\nimport { BehaviorSubject, forkJoin } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"./auth.service\";\nimport * as i3 from \"./api-config.service\";\nexport let CartService = /*#__PURE__*/(() => {\n  class CartService {\n    constructor(http, authService, apiConfig) {\n      this.http = http;\n      this.authService = authService;\n      this.apiConfig = apiConfig;\n      this.cartItems = new BehaviorSubject([]);\n      this.cartItems$ = this.cartItems.asObservable();\n      // Remove hardcoded apiUrl - use apiConfig throughout\n      // Load cart based on authentication status\n      if (this.authService.isAuthenticated()) {\n        this.loadCartFromServer();\n      } else {\n        // Load cart from localStorage for offline support\n        const savedCart = localStorage.getItem('cart');\n        if (savedCart) {\n          try {\n            const parsed = JSON.parse(savedCart);\n            this.cartItems.next([...parsed]);\n          } catch (e) {\n            localStorage.removeItem('cart');\n            this.cartItems.next([]);\n          }\n        }\n      }\n    }\n    getHeaders() {\n      const token = this.authService.getToken();\n      return new HttpHeaders({\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      });\n    }\n    getUserId() {\n      const user = this.authService.getCurrentUser();\n      return user?.id || 1;\n    }\n    getCart() {\n      const userId = this.getUserId();\n      return this.http.get(this.apiConfig.getApiUrl(`cart/${userId}`));\n    }\n    addToCart(product, quantity = 1) {\n      if (this.authService.isAdmin()) {\n        console.warn('Admin users cannot add items to cart');\n        return;\n      }\n      const userId = this.getUserId();\n      const cartRequest = {\n        productId: product.id,\n        productName: product.name,\n        quantity,\n        price: product.price\n      };\n      console.log('Adding to cart:', cartRequest, 'for user:', userId);\n      console.log('API URL:', this.apiConfig.getApiUrl(`cart/${userId}/add`));\n      // Try without authentication headers first since cart service doesn't require auth\n      this.http.post(this.apiConfig.getApiUrl(`cart/${userId}/add`), cartRequest).subscribe({\n        next: response => {\n          console.log('Item added to cart successfully:', response);\n          setTimeout(() => this.loadCartFromServer(), 500);\n          this.showAddToCartNotification(product.name, quantity);\n        },\n        error: error => {\n          console.error('Error adding to cart:', error);\n          console.error('Error details:', error.error);\n          console.error('Error status:', error.status);\n          if (error.status === 401) {\n            alert('Session expired. Please login again.');\n          } else if (error.status === 0) {\n            alert('Network error. Please check if the server is running.');\n          } else {\n            alert('Failed to add item to cart. Please try again.');\n          }\n        }\n      });\n    }\n    addToLocalCart(product, quantity) {\n      const currentItems = [...this.cartItems.value];\n      const existingItem = currentItems.find(item => item.id === product.id && item.size === product.size);\n      if (existingItem) {\n        existingItem.quantity += quantity;\n      } else {\n        currentItems.push({\n          ...product,\n          quantity\n        });\n      }\n      this.updateLocalCart(currentItems);\n      this.showAddToCartNotification(product.name, quantity);\n    }\n    loadCartFromServer() {\n      const userId = this.getUserId();\n      console.log('Loading cart for user:', userId);\n      this.http.get(this.apiConfig.getApiUrl(`cart/${userId}`)).subscribe({\n        next: response => {\n          console.log('Cart response:', response);\n          const items = response.items || [];\n          if (items.length > 0) {\n            const productRequests = items.map(item => this.http.get(this.apiConfig.getApiUrl(`products/${item.productId}`)));\n            forkJoin(productRequests).subscribe({\n              next: products => {\n                const enrichedItems = items.map((item, index) => ({\n                  ...products[index],\n                  quantity: item.quantity,\n                  cartItemId: item.id\n                }));\n                this.cartItems.next(enrichedItems);\n              },\n              error: () => this.cartItems.next([])\n            });\n          } else {\n            this.cartItems.next([]);\n          }\n        },\n        error: error => {\n          console.error('Error loading cart:', error);\n          this.cartItems.next([]);\n        }\n      });\n    }\n    updateCartItem(productId, quantity) {\n      if (this.authService.isAuthenticated()) {\n        return this.http.put(this.apiConfig.getApiUrl('cart/update'), {\n          productId,\n          quantity\n        }, {\n          headers: this.getHeaders()\n        });\n      } else {\n        const currentItems = this.cartItems.value;\n        const item = currentItems.find(item => item.id === productId);\n        if (item) {\n          if (quantity <= 0) {\n            this.removeFromCart(productId);\n          } else {\n            item.quantity = quantity;\n            this.updateLocalCart(currentItems);\n          }\n        }\n      }\n    }\n    removeFromCart(productId, size) {\n      const userId = this.getUserId();\n      this.http.delete(this.apiConfig.getApiUrl(`cart/${userId}/remove/${productId}`)).subscribe({\n        next: () => this.loadCartFromServer(),\n        error: error => console.error('Error removing from cart:', error)\n      });\n    }\n    clearCart() {\n      const userId = this.getUserId();\n      this.http.delete(this.apiConfig.getApiUrl(`cart/${userId}/clear`)).subscribe({\n        next: () => {\n          this.cartItems.next([]);\n        },\n        error: error => console.error('Error clearing cart:', error)\n      });\n    }\n    getCartTotal() {\n      return this.cartItems.value.reduce((total, item) => total + item.price * item.quantity, 0);\n    }\n    getCartItemCount() {\n      return this.cartItems.value.reduce((count, item) => count + item.quantity, 0);\n    }\n    updateLocalCart(items) {\n      const newItems = [...items];\n      this.cartItems.next(newItems);\n      if (newItems.length === 0) {\n        localStorage.removeItem('cart');\n      } else {\n        localStorage.setItem('cart', JSON.stringify(newItems));\n      }\n    }\n    updateQuantity(productId, quantity, size) {\n      if (quantity <= 0) {\n        this.removeFromCart(productId, size);\n      } else {\n        // Remove and re-add with new quantity\n        const userId = this.getUserId();\n        this.http.delete(this.apiConfig.getApiUrl(`cart/${userId}/remove/${productId}`)).subscribe({\n          next: () => {\n            const item = this.cartItems.value.find(i => i.id === productId);\n            if (item) {\n              const cartRequest = {\n                productId: item.id,\n                productName: item.name,\n                quantity,\n                price: item.price\n              };\n              this.http.post(this.apiConfig.getApiUrl(`cart/${userId}/add`), cartRequest).subscribe({\n                next: () => this.loadCartFromServer(),\n                error: error => console.error('Error updating quantity:', error)\n              });\n            }\n          },\n          error: error => console.error('Error updating quantity:', error)\n        });\n      }\n    }\n    // Sync local cart with server when user logs in\n    syncCartWithServer() {\n      if (this.authService.isAuthenticated() && this.cartItems.value.length > 0) {\n        this.cartItems.value.forEach(item => {\n          this.addToCart(item, item.quantity);\n        });\n        this.updateLocalCart([]);\n      }\n    }\n    showAddToCartNotification(productName, quantity) {\n      // Create notification element\n      const notification = document.createElement('div');\n      notification.className = 'cart-notification';\n      notification.innerHTML = `\n      <div class=\"notification-content\">\n        <i class=\"bi bi-check-circle-fill text-success me-2\"></i>\n        <span><strong>${productName}</strong> ${quantity > 1 ? `(${quantity})` : ''} added to cart!</span>\n        <i class=\"bi bi-cart-fill ms-2\"></i>\n      </div>\n    `;\n      // Add styles\n      notification.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #D6A99D, #FBF3D5);\n      color: #2c3e50;\n      padding: 15px 20px;\n      border-radius: 12px;\n      box-shadow: 0 8px 25px rgba(0,0,0,0.15);\n      z-index: 9999;\n      font-weight: 600;\n      border: 2px solid #9CAFAA;\n      backdrop-filter: blur(10px);\n      animation: slideInRight 0.4s ease-out;\n      max-width: 300px;\n    `;\n      // Add animation keyframes if not already added\n      if (!document.querySelector('#cart-notification-styles')) {\n        const style = document.createElement('style');\n        style.id = 'cart-notification-styles';\n        style.textContent = `\n        @keyframes slideInRight {\n          from { transform: translateX(100%); opacity: 0; }\n          to { transform: translateX(0); opacity: 1; }\n        }\n        @keyframes slideOutRight {\n          from { transform: translateX(0); opacity: 1; }\n          to { transform: translateX(100%); opacity: 0; }\n        }\n        .cart-notification .notification-content {\n          display: flex;\n          align-items: center;\n          font-size: 14px;\n        }\n      `;\n        document.head.appendChild(style);\n      }\n      // Add to DOM\n      document.body.appendChild(notification);\n      // Remove after 3 seconds\n      setTimeout(() => {\n        notification.style.animation = 'slideOutRight 0.4s ease-in';\n        setTimeout(() => {\n          if (notification.parentNode) {\n            notification.parentNode.removeChild(notification);\n          }\n        }, 400);\n      }, 3000);\n    }\n    static {\n      this.ɵfac = function CartService_Factory(t) {\n        return new (t || CartService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.AuthService), i0.ɵɵinject(i3.ApiConfigService));\n      };\n    }\n    static {\n      this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n        token: CartService,\n        factory: CartService.ɵfac,\n        providedIn: 'root'\n      });\n    }\n  }\n  return CartService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}